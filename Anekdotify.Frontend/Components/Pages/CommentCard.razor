@inject CommentClient CommentClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="collapse" id="commentCollapseToJoke_@Comment.JokeId">
    <div class="card card-body rounded-4 mb-3 p-3 position-relative">
        <div class="position-absolute top-0 end-0 p-2">
            <div class="d-flex gap-3 align-items-center"> 
                

                @if (Comment.Replies != null && Comment.Replies.Any())
                {
                    <div class="position-relative"> 
                        <button class="btn btn-outline-secondary rounded-circle shadow-sm btn-sm"
                                data-bs-toggle="collapse"
                                data-bs-target="#repliesCollapse_@Comment.CommentId"
                                aria-expanded="false"
                                aria-controls="repliesCollapse_@Comment.CommentId"
                                title="Toggle replies">
                            <i class="bi bi-chat"></i>
                        </button>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            @Comment.Replies.Count
                            <span class="visually-hidden">replies</span>
                        </span>
                    </div>
                }
                <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteCommentModal_@Comment.CommentId" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>

        <p class="card-text text-secondary">@Comment.CommentText</p>
    </div>
</div>


<div class="modal fade" id="deleteCommentModal_@Comment.CommentId" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete comment?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong>this comment</strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" @onclick="() => OnDeleteCommentAsync(Comment.CommentId)">Delete</button>
            </div>
        </div>
    </div>
</div>


@if (Comment.Replies != null && Comment.Replies.Any())
{
    <div class="collapse mt-2 ms-4" id="repliesCollapse_@Comment.CommentId">
        <div data-bs-spy="scroll"
             data-bs-target="#repliesCollapse_@Comment.CommentId"
             data-bs-root-margin="0px 0px -40%"
             data-bs-smooth-scroll="true"
             class="scrollspy-example bg-body-light p-3 rounded-2"
             tabindex="0"
             style="max-height: 400px; overflow-y: auto;">

            @foreach (var reply in Comment.Replies.OrderBy(r => r.CommentDate))
            {
                <CommentCard Comment="@reply" />
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public CommentDTO Comment { get; set; } = default!;

    private async Task OnDeleteCommentAsync(int id)
    {
        await CommentClient.DeleteCommentAsync(id);

        await JSRuntime.InvokeVoidAsync("bootstrap.Modal.getInstance", $"#deleteCommentModal_{id}", "hide");

        NavigationManager.Refresh();
    }
}