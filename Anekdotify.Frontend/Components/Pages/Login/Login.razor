@page "/login"
@using Anekdotify.Frontend.Services
@using Anekdotify.Models.Models
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Mvc
@using Microsoft.JSInterop

@rendermode InteractiveServer
@inject ApiClient ApiClient
@inject IToastService ToastService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IOAuthService OAuthService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<Login> Logger

<PageTitle>Login - Anekdotify</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2>Welcome to Anekdotify</h2>
            <p>Sign in to your account</p>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                @_errorMessage
            </div>
        }

        <div class="login-body">


            <!-- Existing login form -->
            <EditForm Model="loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
                <DataAnnotationsValidator />

                <div class="form-floating mb-3">
                    <InputText @bind-Value="loginModel.Username" class="form-control" id="email"
                        placeholder="name@example.com" />
                    <label for="email">Email address</label>
                    <ValidationMessage For="() => loginModel.Username" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText type="password" @bind-Value="loginModel.Password" class="form-control" id="password"
                        placeholder="Password" />
                    <label for="password">Password</label>
                    <ValidationMessage For="() => loginModel.Password" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-dark w-100 mb-3" disabled="@_isLoading">
                    @if (_isLoading && _loadingProvider == "Local")
                    {
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    }
                    Sign In
                </button>
            </EditForm>
            <hr class="divider-line" />
            <p class="text-center mb-3">Or continue with</p>
            <!-- OAuth Login Buttons -->
            <div class="oauth-section mb-4">
                <button type="button" class="btn btn-secondary w-100 mb-2 oauth-btn" @onclick="LoginWithGitHub"
                    disabled="@_isLoading">
                    @if (_loadingProvider == "GitHub")
                    {
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    }
                    else
                    {
                        <i class="bi bi-github me-2"></i>
                    }
                    Continue with GitHub
                </button>

                <button type="button" class="btn btn-danger w-100 mb-3 oauth-btn" @onclick="LoginWithGoogle"
                    disabled="@_isLoading">
                    @if (_loadingProvider == "Google")
                    {
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    }
                    else
                    {
                        <i class="bi bi-google me-2"></i>
                    }
                    Continue with Google
                </button>



            </div>
            <p class="text-center">
                Don't have an account? <a href="/register">Sign up</a>
            </p>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private LoginDto loginModel { get; set; } = new();


    private string? _errorMessage;
    private bool _isLoading = false;
    private string? _loadingProvider;

    protected override void OnInitialized()
    {
        // Check for error message from OAuth callback
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("error", out var error))
        {
            _errorMessage = error.ToString();
        }
    }

    private async Task LoginWithGitHub()
    {
        try
        {
            _isLoading = true;
            _loadingProvider = "GitHub";
            _errorMessage = null;
            StateHasChanged();

            var githubUrl = await OAuthService.GetGitHubLoginUrlAsync();
            await JSRuntime.InvokeVoidAsync("open", githubUrl, "_self");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initiate GitHub login");
            _errorMessage = "Failed to initiate GitHub login. Please try again.";
        }
        finally
        {
            _isLoading = false;
            _loadingProvider = null;
            StateHasChanged();
        }
    }

    private async Task LoginWithGoogle()
    {
        try
        {
            _isLoading = true;
            _loadingProvider = "Google";
            _errorMessage = null;
            StateHasChanged();

            var googleUrl = await OAuthService.GetGoogleLoginUrlAsync();
            await JSRuntime.InvokeVoidAsync("open", googleUrl, "_self");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initiate Google login");
            _errorMessage = "Failed to initiate Google login. Please try again.";
        }
        finally
        {
            _isLoading = false;
            _loadingProvider = null;
            StateHasChanged();
        }
    }

    private async Task HandleLogin()
    {
        try
        {
            _isLoading = true;
            var response = await ApiClient.PostAsync<LoginResponseModel, LoginDto>("api/account/login", loginModel);
            if (response.IsSuccess && response.Data != null)
            {
                await ((CustomAuthStateProvider)AuthenticationStateProvider).MarkUserAsAuthenticated(response.Data);
                NavigationManager.NavigateTo("/");
            }
            else
            {
                ToastService?.ShowError("Login failed. Please check your credentials.");
            }
            loginModel = new LoginDto();
        }
        catch (Exception e)
        {
            ToastService?.ShowError($"An error occurred while logging in: {e.Message}");
        }
        finally
        {
            _isLoading = false;
            _loadingProvider = null;
        }
    }
}